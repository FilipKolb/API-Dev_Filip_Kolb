name: Deliver container

on: push

jobs:
  delivery:
    runs-on: ubuntu-latest
    name: Deliver container
    steps:
      - name: Check out repository
        uses: actions/checkout@v1

      - name: Docker login
        run: docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Build
        run: docker build -t ${{ secrets.DOCKER_USER }}/gymmembers-api-service:latest .

      - name: Upload container to Docker Hub with Push
        run: docker push ${{ secrets.DOCKER_USER }}/gymmembers-api-service:latest
  build:
    runs-on: ubuntu-latest
    steps:

        - uses: actions/checkout@v2
        - name: Install python
          uses: actions/setup-python@v2
          with:
            python-version: 3

        - name: Install python dependencies
          run: pip install -r requirements.txt

        - name: Set context to Okteto Cloud
          uses: okteto/context@latest
          with:
            token: ${{ secrets.OKTETO_TOKEN }}

        - name: Deploy your preview environment
          uses: okteto/deploy-preview@latest
          env:
            GITHUB_TOKEN: ${{ secrets.GYMMEMBERSREPO_TOKEN }}
          with:
            name: staging-${{ github.event.number }}-OKTETO_USERNAME
            scope: personal
            timeout: 15m

        - uses: nev7n/wait_for_response@v1
          with:
            url: https://api-staging-${{ github.event.number }}-okteto_username.cloud.okteto.net
            responseCode: 200
            timeout: 4000

        - name: Build and deploy application container to Okteto Namespace
          if: ${{ github.event_name == 'push' }}
          uses: okteto/deploy-stack@master
          with:
            name: okteto-gymmemberapi-app
            build: true